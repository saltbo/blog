---
title: "API网关技术总结"
description: ""
image: ""
date: 2021-04-12T03:10:00+07:00
lastmod: 2022-01-09T06:24:00+07:00
author: "闫勃"
tags:
categories:
draft: false
---

# 一、介绍

API 网关作为微服务架构的入口，承载了所有的外部流量。市面上的 API 网关有 Kong、Traefik、Ambassador、Tyk、Zuul 等，他们有的是纯 Go 语言研发的，有的是基于 Envoy 开发的，有的是基于 Nginx 开发的。得到的 API 网关是纯 Go 语言开发的，在研发的过程中涉及到了很多的技术点，通过本文将之进行一次总结。

# 二、名词解释

- 路由：这里主要指 HTTP 路由，比如`GET /chons/services/odob`
- ServeMux：路由选择器，用来匹配、管理路由
- 负载均衡：将负载（工作任务，访问请求）进行平衡、分摊到多个操作单元（服务器，组件）上进行执行
- 限流：通过限制请求的流量以达到保护系统的目的
- 熔断：当下游的服务因为某种原因突然变得不可用或响应过慢，上游服务为了保证自己整体服务的可用性，不再继续调用目标服务，直接返回，快速释放资源
- 授权：是指赋予用户一定的权限
- 鉴权：是指验证用户是否拥有访问系统的权利
- 签名：是指验证用户的请求是否被篡改

# 三、涉及技术

## 3.1、路由

在讲路由之前我们需要了解一个典型的 HTTP 数据包是什么样子的，这里我们以访问得到官网来举例，当我们使用 curl 访问www.igetget.com/news的时候他的数据包如下所示：

```shell
curl -v www.igetget.com/news
*   Trying 203.107.55.63...
* TCP_NODELAY set
* Connected to www.igetget.com (203.107.55.63) port 80 (#0)
> GET /news HTTP/1.1
> Host: www.igetget.com
> User-Agent: curl/7.64.1
> Accept: */*
```

- `Trying 203.107.55.63`意味着 curl 查到了`www.igetget.com`这个域名对应的 IP 地址是`203.107.55.63`
- `Connected to www.igetget.com (203.107.55.63) port 80`：已经连接到`203.107.55.63`的 80 端口
- `GET /news HTTP/1.1` 基于 HTTP1.1 协议通过 GET 的方式请求/news 地址
- `Host: www.igetget.com` 服务器名称是`www.igetget.com`

以上信息就是一个 HTTP 请求的关键信息，当服务器端收到这些信息之后他就需要对其进行处理。

1. 检查www.igetget.com是否存在，如果存在则开始匹配路由
1. 匹配/news 是否存在，如果存在匹配对应的 method GET 是否存在，如果存在指向的是哪个服务

路由的部分基本就是这两步，流程搞清楚就不难。难点在于因为我们是纯 Go 语言进行研发，而 Go 社区的路由选择器 Mux 一般都只有添加路由而没有更新和删除路由的实现，所以我们需要自行基于前缀树实现一个支持 CURD 的 ServeMux。

## 3.2、负载均衡

### 3.2.1、介绍

我们第一次了解到负载均衡就是阿里云的 SLB，后来做网关的过程中又了解到更多负载均衡的知识。

早期我们的服务都是跑在 ECS 上，当流量较大一台服务器不够的时候我们就需要水平扩容。这时如何让流量同时访问到多台服务器呢？ 有两个方案：DNS 解析多个 IP 或者使用 SLB。通过 DNS 可以给一个域名解析多个 IP，然后访问域名的时候会访问到不同的服务器上。但是该方案的问题在于可能一个服务器的流量多，一个服务器的流量少。这也就是为什么要使用负载均衡了。

从“负载均衡”这个名字上也能体现出来一些：**将负载（工作任务，访问请求）进行平衡、分摊到多个操作单元（服务器，组件）上进行执行。**

说回到网关，为什么网关也需要负载均衡？因为网关后面挂载的都是 N 多微服务，每个微服务又有 N 多的节点。

### 3.2.2、负载均衡算法

- 轮训：平均的将流量分配到每一个节点上
- 加权轮询：按照权重将流量分配到每一个节点上
- 哈希：可以指定哈希的参数，比如节点地址，这时流量总会分配到同一个节点上
- 随机：随机的将流量分配到每个节点上

## 3.3、限流

### 3.3.1、为什么要限流

每个服务都有自己能提供的流量上限，如果又未预知的流量涌向服务器就会导致服务器因为负载过高儿崩溃。所以在上游我们需要设置一个能够提供最大流量的限流值，如果流量超过可负载范围则直接拒绝请求，从而保证有损服务而非不服务。

### 3.3.2、限流算法

## 3.4、熔断

### 3.4.1、为什么要熔断

![](/images/posts/s3.us-west-2.amazonaws.com_Untitled.png)

当下游的服务因为某种原因突然变得不可用或响应过慢，上游服务为了保证自己整体服务的可用性，不再继续调用目标服务，直接返回，快速释放资源。如果目标服务情况好转则恢复调用。

### 3.4.2、熔断原理

![](/images/posts/s3.us-west-2.amazonaws.com_Untitled.png)

这里面有三种断路器状态：Open、Half Open 和 Closed。

1. 当请求超过一定的并发数就会进入 Open 状态。
1. 当请求的错误率超过一定阈值则会进入 Open 状态。
1. 一定时间后会尝试放行一小部分请求并检测是否成功，如果成功则恢复到 Closed 状态

## 3.5、授权鉴权

![](/images/posts/s3.us-west-2.amazonaws.com_Untitled.png)

我们采用无状态的 JWT 来进行授权鉴权，所以网关并不存储用户的登录状态，而是通过算法来保证用户的登录权限。

# 三、架构设计

# 四、运维管理

### 4.1 ETCD 集群

### 4.2 GW 集群

# 五、参考文章

- [https://zhuanlan.zhihu.com/p/68733507](https://zhuanlan.zhihu.com/p/68733507)
- [https://www.cnblogs.com/rjzheng/p/10340176.html](https://www.cnblogs.com/rjzheng/p/10340176.html)
- [https://zhuanlan.zhihu.com/p/158948815](https://zhuanlan.zhihu.com/p/158948815)
